<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESP32 æ™ºæ…§é¬§é˜æ§åˆ¶é¢æ¿</title>
<style>
body {
  font-family: "Noto Sans TC", system-ui, sans-serif;
  background: #f3f4f6;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 720px;
  margin: 20px auto;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  padding: 20px;
}
h1 {
  text-align: center;
  margin-bottom: 10px;
  color: #2563eb;
}
label {
  display: block;
  margin-top: 10px;
}
input, button {
  font-size: 1rem;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #bbb;
}
button {
  cursor: pointer;
  background-color: #2563eb;
  color: white;
  border: none;
  transition: background-color 0.2s;
}
button:hover {
  background-color: #1e40af;
}
.row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.row > div {
  flex: 1 1 110px;
}
.alarm {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top: 1px solid #eee;
  padding: 8px 0;
}
#time {
  font-weight: bold;
  color: #dc2626;
}
.action-bar {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ•“ ESP32 æ™ºæ…§é¬§é˜</h1>
  <div>ç›®å‰æ™‚é–“ï¼š<span id="time">--:--:--</span></div>

  <h2>æ–°å¢é¬§é˜</h2>
  <div class="row">
      <div><label><input id="year" type="number" min="2024" max="2100" value="2025"> å¹´</label></div>
      <div><label><input id="month" type="number" min="1" max="12" value="1"> æœˆ</label></div>
      <div><label><input id="day" type="number" min="1" max="31" value="1"> æ—¥</label></div>
      <div><label><input id="hour" type="number" min="0" max="23" value="0"> æ™‚</label></div>
      <div><label><input id="minute" type="number" min="0" max="59" value="0"> åˆ†</label></div>
  </div>
  <h2>é¸æ“‡é¬§é˜éŸ³æ¨‚</h2>
  <label>
  éŸ³æ¨‚ï¼š
  <select id="song">
    <option value="NOTES_STAR">æ˜Ÿæ˜Ÿ</option>
    <option value="NOTES_SKYCASTLE">å¤©ç©ºä¹‹åŸ</option>
    <option value="NOTES_HAPPYBIRTHDAY">ç”Ÿæ—¥å¿«æ¨‚</option>
  </select>
  </label>

  <div class="action-bar">
    <button id="add">â• æ–°å¢é¬§é˜</button>
    <button id="reset">ğŸ§¹ é‡ç½®é¬§é˜</button>
    <button id="test">ğŸ”” æ¸¬è©¦éŸ¿éˆ´</button>
    <button id="stop">ğŸ›‘ åœæ­¢éˆ´è²</button>
  </div>

  <h2>å·²è¨­å®šé¬§é˜</h2>
  <div id="list">
    <p style="color:#999;">ç›®å‰æ²’æœ‰è¨­å®šä»»ä½•é¬§é˜ â°</p>
  </div>
</div>

<script>
function pad(n){ return (n<10 ? '0' : '') + n; }

async function api(path, opt){
  const r = await fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opt));
  return r.json().catch(()=>({ok:r.ok}));
}
function songName(code){
  switch(code){
    case "NOTES_STAR": return "å°æ˜Ÿæ˜Ÿ";
    case "NOTES_SKYCASTLE": return "å¤©ç©ºä¹‹åŸ";
    case "NOTES_HAPPYBIRTHDAY": return "ç”Ÿæ—¥å¿«æ¨‚";
    default: return "æœªçŸ¥æ›²ç›®";
  }
}
async function refresh(){
  const t = await (await fetch('/api/time')).text();
  document.getElementById('time').textContent = t || '--:--:--';

  const data = await api('/api/alarms');
  const list = document.getElementById('list');
  list.innerHTML = '';

  if (!data.alarms || data.alarms.length === 0) {
    list.innerHTML = "<p style='color:#999;'>ç›®å‰æ²’æœ‰è¨­å®šä»»ä½•é¬§é˜ â°</p>";
    return;
  }

  data.alarms.forEach((a, idx) => {
    const d = document.createElement('div');
    d.className = 'alarm';
    d.innerHTML = `
      <div>ğŸ•’ A${idx+1} ${a.enabled ? 'âœ”ï¸' : 'âŒ'} 
      ${a.y}-${pad(a.m)}-${pad(a.d)} ${pad(a.h)}:${pad(a.min)}
      ${a.song ? `ğŸµ ${songName(a.song)}` : ''}
      </div>
      <div>
        <button class="toggle" data-i="${idx}">
          ${a.enabled ? 'åœç”¨' : 'å•Ÿç”¨'}
        </button>
        <button class="del" data-i="${idx}">åˆªé™¤</button>
      </div>`;
    list.appendChild(d);
  });

  list.querySelectorAll('.del').forEach(b => b.onclick = async ()=>{
    if(confirm("ç¢ºå®šè¦åˆªé™¤é€™çµ„é¬§é˜å—ï¼Ÿ")){
      await api('/api/alarms', {
        method: 'DELETE',
        body: JSON.stringify({ i: +b.dataset.i })
      });
      refresh();
    }
  });

  list.querySelectorAll('.toggle').forEach(b => b.onclick = async ()=>{
    await api('/api/alarms', {
      method: 'POST',
      body: JSON.stringify({ toggle: +b.dataset.i })
    });
    refresh();
  });
}

document.getElementById('add').onclick = async ()=>{
  const body = JSON.stringify({
    year:+year.value,
    month:+month.value,
    day:+day.value,
    hour:+hour.value,
    minute:+minute.value,
    enabled:true,
    song: song.value
  });
  await api('/api/alarms',{method:'POST', body});
  refresh();
};

document.getElementById('reset').onclick = async ()=>{
  if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰é¬§é˜å—ï¼Ÿ")){
    await api('/api/alarms', { method: 'DELETE', body: JSON.stringify({ all: true }) });
    refresh();
  }
};

document.getElementById('test').onclick = ()=> fetch('/api/ring/test',{method:'POST'});
document.getElementById('stop').onclick = ()=> fetch('/api/ring/stop',{method:'POST'});

setInterval(refresh, 1000);
refresh();
</script>

</body>
</html>


