<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ESP32 æ™ºæ…§é¬§é˜æ§åˆ¶é¢æ¿</title>
<style>
body {
  font-family: "Noto Sans TC", system-ui, sans-serif;
  background: #f3f4f6;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 720px;
  margin: 20px auto;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  padding: 20px;
}
h1 {
  text-align: center;
  margin-bottom: 10px;
  color: #2563eb;
}
label {
  display: block;
  margin-top: 10px;
}
input, button {
  font-size: 1rem;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #bbb;
}
button {
  cursor: pointer;
  background-color: #2563eb;
  color: white;
  border: none;
  transition: background-color 0.2s;
}
button:hover {
  background-color: #1e40af;
}
.row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.row > div {
  flex: 1 1 110px;
}
.alarm {
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top: 1px solid #eee;
  padding: 8px 0;
}
#time {
  font-weight: bold;
  color: #dc2626;
}
.action-bar {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ•“ ESP32 æ™ºæ…§é¬§é˜</h1>
  <div>ç›®å‰æ™‚é–“ï¼š<span id="time">--:--:--</span></div>

  <h2>æ–°å¢é¬§é˜</h2>
  <div class="row">
    <div><label>å¹´ <input id="year" type="number" min="2024" max="2100" value="2025"></label></div>
    <div><label>æœˆ <input id="month" type="number" min="1" max="12" value="1"></label></div>
    <div><label>æ—¥ <input id="day" type="number" min="1" max="31" value="1"></label></div>
    <div><label>æ™‚ <input id="hour" type="number" min="0" max="23" value="0"></label></div>
    <div><label>åˆ† <input id="minute" type="number" min="0" max="59" value="0"></label></div>
  </div>
  <label><input id="enabled" type="checkbox" checked> å•Ÿç”¨</label>

  <div class="action-bar">
    <button id="add">â• æ–°å¢é¬§é˜</button>
    <button id="reset">ğŸ§¹ é‡ç½®é¬§é˜</button>
    <button id="test">ğŸ”” æ¸¬è©¦éŸ¿éˆ´</button>
    <button id="stop">ğŸ›‘ åœæ­¢éˆ´è²</button>
  </div>

  <h2>å·²è¨­å®šé¬§é˜</h2>
  <div id="list">
    <p style="color:#999;">ç›®å‰æ²’æœ‰è¨­å®šä»»ä½•é¬§é˜ â°</p>
  </div>
</div>

<script>
// === å·¥å…·å‡½å¼ ===
function pad(n){ return (n<10 ? '0' : '') + n; }

async function api(path, opt){
  const r = await fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opt));
  return r.json().catch(()=>({ok:r.ok}));
}

// === æ›´æ–°æ™‚é–“èˆ‡é¬§é˜æ¸…å–® ===
async function refresh(){
  // æ›´æ–°ç›®å‰æ™‚é–“
  const t = await (await fetch('/api/time')).text();
  document.getElementById('time').textContent = t || '--:--:--';

  // æ›´æ–°é¬§é˜æ¸…å–®
  const data = await (await fetch('/api/alarms')).json();
  const list = document.getElementById('list');
  list.innerHTML = '';

  if (!data.alarms || data.alarms.length === 0) {
    list.innerHTML = "<p style='color:#999;'>ç›®å‰æ²’æœ‰è¨­å®šä»»ä½•é¬§é˜ â°</p>";
    return;
  }

  data.alarms.forEach((a, idx)<script>
// === å·¥å…·å‡½å¼ ===
function pad(n){ return (n<10 ? '0' : '') + n; }

async function api(path, opt){
  const r = await fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opt));
  return r.json().catch(()=>({ok:r.ok}));
}

// === æ›´æ–°æ™‚é–“èˆ‡é¬§é˜æ¸…å–® ===
async function refresh(){
  // æ›´æ–°ç›®å‰æ™‚é–“
  const t = await (await fetch('/api/time')).text();
  document.getElementById('time').textContent = t || '--:--:--';

  // æ›´æ–°é¬§é˜æ¸…å–®
  const data = await (await fetch('/api/alarms')).json();
  const list = document.getElementById('list');
  list.innerHTML = '';=>{
    const d = document.createElement('div');
    d.className = 'alarm';
    d.innerHTML = `
      <div>ğŸ•’ A${idx+1} ${a.enabled ? 'âœ”ï¸' : 'âŒ'} 
      ${a.y}-${pad(a.m)}-${pad(a.d)} ${pad(a.h)}:${pad(a.min)}</div>
      <div>
        <button class="toggle" data-i="${idx}">
          ${a.enabled ? 'åœç”¨' : 'å•Ÿç”¨'}
        </button>
        <button class="del" data-i="${idx}">åˆªé™¤</button>
      </div>`;
    list.appendChild(d);
  });

  // ç¶å®šåˆªé™¤æŒ‰éˆ•
  list.querySelectorAll('.del').forEach(b => b.onclick = async ()=>{
    if(confirm("ç¢ºå®šè¦åˆªé™¤é€™çµ„é¬§é˜å—ï¼Ÿ")){
      await api('/api/alarms', {
        method: 'DELETE',
        body: JSON.stringify({ i: +b.dataset.i })
      });
      refresh();
    }
  });

  // ç¶å®šå•Ÿç”¨/åœç”¨æŒ‰éˆ•
  list.querySelectorAll('.toggle').forEach(b => b.onclick = async ()=>{
    await api('/api/alarms', {
      method: 'POST',
      body: JSON.stringify({ toggle: +b.dataset.i })
    });
    refresh();
  });
}

// === æ–°å¢é¬§é˜ ===
document.getElementById('add').onclick = async ()=>{
  const body = JSON.stringify({
    year:+year.value,
    month:+month.value,
    day:+day.value,
    hour:+hour.value,
    minute:+minute.value,
    enabled:enabled.checked
  });
  await api('/api/alarms',{method:'POST', body});
  refresh();
};

// === æ¸¬è©¦éŸ¿éˆ´ ===
document.getElementById('test').onclick = ()=> fetch('/api/ring/test',{method:'POST'});

// === åœæ­¢éˆ´è² ===
document.getElementById('stop').onclick = ()=> fetch('/api/ring/stop',{method:'POST'});

// === è‡ªå‹•åˆ·æ–° ===
setInterval(refresh, 1000);
refresh();
</script>
</body>
</html>
